:PROPERTIES:
:ID:       8fb71644-dde4-46aa-99ae-a47703db55fa
:END:
# SPDX-FileCopyrightText: 2024 László Vaskó <vlaci@fastmail.com>
#
# SPDX-License-Identifier: EUPL-1.2
#+FILETAGS: :Emacs:
#+title: Org mode

#+caption: packages
#+begin_src nix :noweb-ref emacs-packages
org-modern org-roam
#+end_src


#+begin_src emacs-lisp :noweb-ref init-el
(setup org
  (:option org-startup-indented t
           org-edit-src-content-indentation 0))

(setup (:package org-modern)
  (:hook-into org-mode-hook))
#+end_src

#+begin_src emacs-lisp :noweb-ref init-el
(setup (:package org-roam)
  (:defer-incrementally ansi-color dash f rx seq magit-section emacsql))
#+end_src

#+begin_src emacs-lisp :noweb-ref vlaci-emacs
;;;###autoload
(defun vl/org-format-src-blocks()
  "Re-indent all src blocks in buffer"
  (interactive)
  (org-babel-map-src-blocks nil
    (with-demoted-errors "Error processing code block: %S"
      (let ((info (org-babel-get-src-block-info)))
        (goto-char beg-body)
        (org-edit-src-code nil "vl/org-fmt-src")
        (with-current-buffer "vl/org-fmt-src"
          (vl/format-buffer)
          (org-edit-src-exit))))))

(defun vl/org-format-file (f)
  (message "Processing file %s" f)
  (with-current-buffer (find-file-noselect f)
    (vl/org-format-src-blocks)
    (save-buffer)
    (kill-buffer)))

(defun vl/format-buffer ()
  (when-let ((formatters (apheleia--get-formatters)))
    (let ((done nil))
      (apheleia-format-buffer
       formatters
       nil
       :callback
       (lambda (&rest err)
         (setq done t)))
      (while (not done)
        (sit-for 0.05)
        (sleep-for 0.05)))))

;;;###autoload
(defun vl/dired-org-format-files ()
  (interactive)
  (mapc #'vl/org-format-file
        (directory-files (dired-current-directory) t "\\.org$")))
#+end_src
